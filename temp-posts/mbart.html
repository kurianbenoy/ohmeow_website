<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Multilingual Sequence Classifaction with the MBart Family | ohmeow</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Multilingual Sequence Classifaction with the MBart Family" />
<meta name="author" content="Wayde Gilliam" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Need to do some multi-lingual sequence classification? Look no further, at least if you want to use MBart and/or the MBart-50 variety of models. Working against the amazon_reviews_multi dataset I’ll show you how to use the blurr library to configure the huggingface objects, build DataLoaders, and train a model that you can use for classifying German text. I’ll throw in a bit of the inference code so that you can see how easy blurr makes it to use your trained model to boot. Let’s go …" />
<meta property="og:description" content="Need to do some multi-lingual sequence classification? Look no further, at least if you want to use MBart and/or the MBart-50 variety of models. Working against the amazon_reviews_multi dataset I’ll show you how to use the blurr library to configure the huggingface objects, build DataLoaders, and train a model that you can use for classifying German text. I’ll throw in a bit of the inference code so that you can see how easy blurr makes it to use your trained model to boot. Let’s go …" />
<link rel="canonical" href="https://ohmeow.com/temp-posts/mbart" />
<meta property="og:url" content="https://ohmeow.com/temp-posts/mbart" />
<meta property="og:site_name" content="ohmeow" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-05-25T00:00:00-05:00" />
<script type="application/ld+json">
{"url":"https://ohmeow.com/temp-posts/mbart","@type":"BlogPosting","headline":"Multilingual Sequence Classifaction with the MBart Family","dateModified":"2021-05-25T00:00:00-05:00","datePublished":"2021-05-25T00:00:00-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://ohmeow.com/temp-posts/mbart"},"author":{"@type":"Person","name":"Wayde Gilliam"},"description":"Need to do some multi-lingual sequence classification? Look no further, at least if you want to use MBart and/or the MBart-50 variety of models. Working against the amazon_reviews_multi dataset I’ll show you how to use the blurr library to configure the huggingface objects, build DataLoaders, and train a model that you can use for classifying German text. I’ll throw in a bit of the inference code so that you can see how easy blurr makes it to use your trained model to boot. Let’s go …","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://ohmeow.com/feed.xml" title="ohmeow" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-163296836-1','auto');ga('require','displayfeatures');ga('send','pageview');</script>

<link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

    <div class="wrapper"><a class="site-title" rel="author" href="/"><img style="height: 60px;" src="/images/ohmeow_logo.png" alt="ohmeow.com"></a><nav class="site-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger" />
          <label for="nav-trigger">
            <span class="menu-icon">
              <svg viewBox="0 0 18 15" width="18px" height="15px">
                <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
              </svg>
            </span>
          </label>
  
          <div class="trigger"><a class="page-link" href="/about/"><span class="top-menu-text">About Me</span></a><a class="page-link" href="/search/"><span class="top-menu-text">Search</span></a><a class="page-link" href="/categories/"><span class="top-menu-text">Tags</span></a></div>
        </nav></div>
  </header><main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Multilingual Sequence Classifaction with the MBart Family</h1><p class="page-description">Need to do some multi-lingual sequence classification? Look no further, at least if you want to use MBart and/or the MBart-50 variety of models.  Working against the `amazon_reviews_multi` dataset I'll show you how to use the `blurr` library to configure the huggingface objects, build DataLoaders, and train a model that you can use for classifying German text.  I'll throw in a bit of the inference code so that you can see how easy `blurr` makes it to use your trained model to boot.  Let's go ...</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-05-25T00:00:00-05:00" itemprop="datePublished">
        May 25, 2021
      </time>• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Wayde Gilliam</span></span>
       • <span class="read-time" title="Estimated read time">
    
    
      6 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#blurr">blurr</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#huggingface">huggingface</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#fastai">fastai</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#multilingual">multilingual</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#sequence classification">sequence classification</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/ohmeow/ohmeow_website/tree/master/_notebooks/2021-05-25-mbart-sequence-classification-with-blurr.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          
          <div class="px-2">
    <a href="https://colab.research.google.com/github/ohmeow/ohmeow_website/blob/master/_notebooks/2021-05-25-mbart-sequence-classification-with-blurr.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2021-05-25-mbart-sequence-classification-with-blurr.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">ohmeow</span><span class="o">-</span><span class="n">blurr</span> <span class="o">-</span><span class="n">q</span>
<span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">datasets</span> <span class="o">-</span><span class="n">q</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.text.all</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">load_dataset</span>
<span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">AutoModelForSequenceClassification</span>

<span class="kn">from</span> <span class="nn">blurr.utils</span> <span class="kn">import</span> <span class="n">BLURR</span>
<span class="kn">from</span> <span class="nn">blurr.data.core</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">blurr.modeling.core</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">from</span> <span class="nn">blurr</span> <span class="kn">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">blurr_version</span>
<span class="kn">from</span> <span class="nn">fastai</span> <span class="kn">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">fa_version</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">pt_version</span>
<span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">hft_version</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using blurr </span><span class="si">{</span><span class="n">blurr_version</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using pytorch </span><span class="si">{</span><span class="n">pt_version</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using fastai </span><span class="si">{</span><span class="n">fa_version</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using transformers </span><span class="si">{</span><span class="n">hft_version</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Using blurr 0.0.25
Using pytorch 1.8.1+cu101
Using fastai 2.3.1
Using transformers 4.6.1
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Data">Data<a class="anchor-link" href="#Data"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">trn_ds</span><span class="p">,</span> <span class="n">val_ds</span><span class="p">,</span> <span class="n">tst_ds</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s2">&quot;amazon_reviews_multi&quot;</span><span class="p">,</span> <span class="s2">&quot;de&quot;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;validation&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Reusing dataset amazon_reviews_multi (/root/.cache/huggingface/datasets/amazon_reviews_multi/de/1.0.0/724e94f4b0c6c405ce7e476a6c5ef4f87db30799ad49f765094cf9770e0f7609)
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">trn_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">trn_ds</span><span class="p">)</span>
<span class="n">val_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">val_ds</span><span class="p">)</span>
<span class="n">tst_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">tst_ds</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><div class="flash flash-warn">
    <svg class="octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M10.561 1.5a.016.016 0 00-.01.004L3.286 8.571A.25.25 0 003.462 9H6.75a.75.75 0 01.694 1.034l-1.713 4.188 6.982-6.793A.25.25 0 0012.538 7H9.25a.75.75 0 01-.683-1.06l2.008-4.418.003-.006a.02.02 0 00-.004-.009.02.02 0 00-.006-.006L10.56 1.5zM9.504.43a1.516 1.516 0 012.437 1.713L10.415 5.5h2.123c1.57 0 2.346 1.909 1.22 3.004l-7.34 7.142a1.25 1.25 0 01-.871.354h-.302a1.25 1.25 0 01-1.157-1.723L5.633 10.5H3.462c-1.57 0-2.346-1.909-1.22-3.004L9.503.429z"></path></svg>
    <strong>Important: </strong>Use a subset of the data when building your model to speed up developement time!
</div></p>
<p>After you got everything, throw the full dataset at it and go get some coffee :)</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="c1"># this won&#39;t work because the rows are ordered by our targets!</span>
<span class="c1"># trn_ds, val_ds = load_dataset(&quot;amazon_reviews_multi&quot;, &quot;de&quot;, split=[&#39;train[:10%]&#39;, &#39;validation[:10%]&#39;])</span>

<span class="n">trn_df</span> <span class="o">=</span> <span class="n">trn_df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">val_df</span> <span class="o">=</span> <span class="n">val_df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">trn_df</span><span class="p">[</span><span class="s1">&#39;is_valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">;</span> <span class="n">val_df</span><span class="p">[</span><span class="s1">&#39;is_valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">trn_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trn_df</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_df</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>200000 5000 205000
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">trn_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>language</th>
      <th>product_category</th>
      <th>product_id</th>
      <th>review_body</th>
      <th>review_id</th>
      <th>review_title</th>
      <th>reviewer_id</th>
      <th>stars</th>
      <th>is_valid</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>de</td>
      <td>sports</td>
      <td>product_de_0865382</td>
      <td>Armband ist leider nach 1 Jahr kaputt gegangen</td>
      <td>de_0203609</td>
      <td>Leider nach 1 Jahr kaputt</td>
      <td>reviewer_de_0267719</td>
      <td>1</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1</th>
      <td>de</td>
      <td>home_improvement</td>
      <td>product_de_0678997</td>
      <td>In der Lieferung war nur Ein Akku!</td>
      <td>de_0559494</td>
      <td>EINS statt ZWEI Akkus!!!</td>
      <td>reviewer_de_0783625</td>
      <td>1</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2</th>
      <td>de</td>
      <td>drugstore</td>
      <td>product_de_0372235</td>
      <td>Ein Stern, weil gar keine geht nicht. Es handelt sich um gebraucht Waren, die Stein haben so ein Belag drauf, wo man sich dabei denken kann, dass jemand schon die benutzt und nicht Mal richtig gewaschen. Bei ein paar ist die Qualität Mangelhaft, siehe Bild. Ein habe ich ausprobiert, richtig gewaschen, dann verfärbt sich..... Wärme halt nicht lange. Deswegen wird es zurückgeschickt.</td>
      <td>de_0238777</td>
      <td>Achtung Abzocke</td>
      <td>reviewer_de_0911426</td>
      <td>1</td>
      <td>False</td>
    </tr>
    <tr>
      <th>3</th>
      <td>de</td>
      <td>drugstore</td>
      <td>product_de_0719501</td>
      <td>Dachte, das wären einfach etwas festere Binden, vielleicht größere Always. Aber die Verpackung ist derartig riesig - wie als hätte man einen riesigen Karton Windeln gekauft... nicht das, was ich wollte ;-)</td>
      <td>de_0477884</td>
      <td>Zu viel des Guten</td>
      <td>reviewer_de_0836478</td>
      <td>1</td>
      <td>False</td>
    </tr>
    <tr>
      <th>4</th>
      <td>de</td>
      <td>toy</td>
      <td>product_de_0022613</td>
      <td>Meine Kinder haben kaum damit gespielt und nach 6 Monaten riss es an der Naht obwohl ich sehr leichte Kinder habe.</td>
      <td>de_0270868</td>
      <td>Qualität sehr schlecht</td>
      <td>reviewer_de_0736276</td>
      <td>1</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">unique_tgt_vals</span> <span class="o">=</span> <span class="n">trn_df</span><span class="o">.</span><span class="n">stars</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">unique_tgt_vals</span><span class="p">)</span>

<span class="n">labels</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">stars</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>5    40000
4    40000
3    40000
2    40000
1    40000
Name: stars, dtype: int64
[1, 2, 3, 4, 5]
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="huggingface-objects">huggingface objects<a class="anchor-link" href="#huggingface-objects"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;facebook/mbart-large-50&quot;</span>
<span class="n">model_cls</span> <span class="o">=</span> <span class="n">AutoModelForSequenceClassification</span>
<span class="n">hf_tok_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;src_lang&#39;</span><span class="p">:</span> <span class="s1">&#39;de_DE&#39;</span><span class="p">,</span> <span class="s1">&#39;tgt_lang&#39;</span><span class="p">:</span> <span class="s1">&#39;de_DE&#39;</span><span class="p">}</span>

<span class="n">hf_arch</span><span class="p">,</span> <span class="n">hf_config</span><span class="p">,</span> <span class="n">hf_tokenizer</span><span class="p">,</span> <span class="n">hf_model</span> <span class="o">=</span> <span class="n">BLURR</span><span class="o">.</span><span class="n">get_hf_objects</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span>  
                                                                  <span class="n">model_cls</span><span class="o">=</span><span class="n">model_cls</span><span class="p">,</span>  
                                                                  <span class="n">tokenizer_kwargs</span><span class="o">=</span><span class="n">hf_tok_kwargs</span><span class="p">,</span> 
                                                                  <span class="n">config_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;num_labels&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)})</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;arch: &#39;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">hf_arch</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;config: &#39;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">hf_config</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tokenizer: &#39;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">hf_tokenizer</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;model: &#39;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">hf_model</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>arch:  &lt;class &#39;str&#39;&gt;
config:  &lt;class &#39;transformers.models.mbart.configuration_mbart.MBartConfig&#39;&gt;
tokenizer:  &lt;class &#39;transformers.models.mbart.tokenization_mbart50_fast.MBart50TokenizerFast&#39;&gt;
model:  &lt;class &#39;transformers.models.mbart.modeling_mbart.MBartForSequenceClassification&#39;&gt;
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><div class="flash flash-warn">
    <svg class="octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M10.561 1.5a.016.016 0 00-.01.004L3.286 8.571A.25.25 0 003.462 9H6.75a.75.75 0 01.694 1.034l-1.713 4.188 6.982-6.793A.25.25 0 0012.538 7H9.25a.75.75 0 01-.683-1.06l2.008-4.418.003-.006a.02.02 0 00-.004-.009.02.02 0 00-.006-.006L10.56 1.5zM9.504.43a1.516 1.516 0 012.437 1.713L10.415 5.5h2.123c1.57 0 2.346 1.909 1.22 3.004l-7.34 7.142a1.25 1.25 0 01-.871.354h-.302a1.25 1.25 0 01-1.157-1.723L5.633 10.5H3.462c-1.57 0-2.346-1.909-1.22-3.004L9.503.429z"></path></svg>
    <strong>Important: </strong>Always good to look into the config as you&#8217;ll often find good defaults to use in your training and inference!
</div></p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">hf_config</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>MBartConfig {
  &#34;_name_or_path&#34;: &#34;facebook/mbart-large-50&#34;,
  &#34;_num_labels&#34;: 3,
  &#34;activation_dropout&#34;: 0.0,
  &#34;activation_function&#34;: &#34;gelu&#34;,
  &#34;add_bias_logits&#34;: false,
  &#34;add_final_layer_norm&#34;: true,
  &#34;architectures&#34;: [
    &#34;MBartForConditionalGeneration&#34;
  ],
  &#34;attention_dropout&#34;: 0.0,
  &#34;bos_token_id&#34;: 0,
  &#34;classif_dropout&#34;: 0.0,
  &#34;classifier_dropout&#34;: 0.0,
  &#34;d_model&#34;: 1024,
  &#34;decoder_attention_heads&#34;: 16,
  &#34;decoder_ffn_dim&#34;: 4096,
  &#34;decoder_layerdrop&#34;: 0.0,
  &#34;decoder_layers&#34;: 12,
  &#34;decoder_start_token_id&#34;: 2,
  &#34;dropout&#34;: 0.1,
  &#34;early_stopping&#34;: true,
  &#34;encoder_attention_heads&#34;: 16,
  &#34;encoder_ffn_dim&#34;: 4096,
  &#34;encoder_layerdrop&#34;: 0.0,
  &#34;encoder_layers&#34;: 12,
  &#34;eos_token_id&#34;: 2,
  &#34;forced_eos_token_id&#34;: 2,
  &#34;gradient_checkpointing&#34;: false,
  &#34;id2label&#34;: {
    &#34;0&#34;: &#34;LABEL_0&#34;,
    &#34;1&#34;: &#34;LABEL_1&#34;,
    &#34;2&#34;: &#34;LABEL_2&#34;,
    &#34;3&#34;: &#34;LABEL_3&#34;,
    &#34;4&#34;: &#34;LABEL_4&#34;
  },
  &#34;init_std&#34;: 0.02,
  &#34;is_encoder_decoder&#34;: true,
  &#34;label2id&#34;: {
    &#34;LABEL_0&#34;: 0,
    &#34;LABEL_1&#34;: 1,
    &#34;LABEL_2&#34;: 2,
    &#34;LABEL_3&#34;: 3,
    &#34;LABEL_4&#34;: 4
  },
  &#34;max_length&#34;: 200,
  &#34;max_position_embeddings&#34;: 1024,
  &#34;model_type&#34;: &#34;mbart&#34;,
  &#34;normalize_before&#34;: true,
  &#34;normalize_embedding&#34;: true,
  &#34;num_beams&#34;: 5,
  &#34;num_hidden_layers&#34;: 12,
  &#34;output_past&#34;: true,
  &#34;pad_token_id&#34;: 1,
  &#34;scale_embedding&#34;: true,
  &#34;static_position_embeddings&#34;: false,
  &#34;tokenizer_class&#34;: &#34;MBart50Tokenizer&#34;,
  &#34;transformers_version&#34;: &#34;4.6.1&#34;,
  &#34;use_cache&#34;: true,
  &#34;vocab_size&#34;: 250054
}</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="DataLoaders">DataLoaders<a class="anchor-link" href="#DataLoaders"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">blocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">HF_TextBlock</span><span class="p">(</span><span class="n">hf_arch</span><span class="p">,</span> <span class="n">hf_config</span><span class="p">,</span> <span class="n">hf_tokenizer</span><span class="p">,</span> <span class="n">hf_model</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">256</span><span class="p">),</span> <span class="n">CategoryBlock</span><span class="p">)</span>
<span class="n">dblock</span> <span class="o">=</span> <span class="n">DataBlock</span><span class="p">(</span><span class="n">blocks</span><span class="o">=</span><span class="n">blocks</span><span class="p">,</span> <span class="n">get_x</span><span class="o">=</span><span class="n">ColReader</span><span class="p">(</span><span class="s1">&#39;review_body&#39;</span><span class="p">),</span> <span class="n">get_y</span><span class="o">=</span><span class="n">ColReader</span><span class="p">(</span><span class="s1">&#39;stars&#39;</span><span class="p">),</span> <span class="n">splitter</span><span class="o">=</span><span class="n">ColSplitter</span><span class="p">())</span>

<span class="n">dls</span> <span class="o">=</span> <span class="n">dblock</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><div class="flash flash-warn">
    <svg class="octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap octicon octicon-zap" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M10.561 1.5a.016.016 0 00-.01.004L3.286 8.571A.25.25 0 003.462 9H6.75a.75.75 0 01.694 1.034l-1.713 4.188 6.982-6.793A.25.25 0 0012.538 7H9.25a.75.75 0 01-.683-1.06l2.008-4.418.003-.006a.02.02 0 00-.004-.009.02.02 0 00-.006-.006L10.56 1.5zM9.504.43a1.516 1.516 0 012.437 1.713L10.415 5.5h2.123c1.57 0 2.346 1.909 1.22 3.004l-7.34 7.142a1.25 1.25 0 01-.871.354h-.302a1.25 1.25 0 01-1.157-1.723L5.633 10.5H3.462c-1.57 0-2.346-1.909-1.22-3.004L9.503.429z"></path></svg>
    <strong>Important: </strong>It&#8217;s almost always useful to look at the <code>shape</code> of things in your batches (esp. when debugging)
</div>
For example, when running on a colab GPU I kept getting CUDA OOM even with a batch size of just 4.  So I looked at the input_ids and saw that they were over 1,000 tokens long in some batches.  So I adjusted the <code>max_length</code> above to ensure they weren't longer that 128 characters and voila, you have the tutorial before you now.</p>
<p>Of course, you should run this with the biggest batch size and sequence size your GPU(s) will support.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">xb</span><span class="p">,</span> <span class="n">yb</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
<span class="n">xb</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>torch.Size([4, 256])</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">dls</span><span class="o">.</span><span class="n">show_batch</span><span class="p">(</span><span class="n">dataloaders</span><span class="o">=</span><span class="n">dls</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">trunc_at</span><span class="o">=</span><span class="mi">1500</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
      <th>category</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>So eine Dümmliche Rückantwort wirft Zweifel am Erzeuger dieser Rückmeldung auf.nana nana So eine Dümmliche Rückantwort wirft Zweifel am Erzeuger dieser Rückmeldung auf.nana nana So eine Dümmliche Rückantwort wirft Zweifel am Erzeuger dieser Rückmeldung auf.nana nana So eine Dümmliche Rückantwort wirft Zweifel am Erzeuger dieser Rückmeldung auf.nana nana So eine Dümmliche Rückantwort wirft Zweifel am Erzeuger dieser Rückmeldung auf.nana nana So eine Dümmliche Rückantwort wirft Zweifel am Erzeuger dieser Rückmeldung auf.nana nana So eine Dümmliche Rückantwort wirft Zweifel am Erzeuger dieser Rückmeldung auf.nana nana So eine Dümmliche Rückantwort wirft Zweifel am Erzeuger dieser Rückmeldung auf.nana nana So eine Dümmliche Rückantwort wirft Zweifel am Erzeuger dieser Rückmeldung auf.nana nana So eine Dümmliche Rückantwort wirft Zweifel am Erzeuger dieser Rückmeldung auf.nana nana So eine Dümmliche Rückantwort wirft Zweifel am Erzeuger dieser Rückmeldung auf.nana nana So</td>
      <td>4</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Leider gehört das P20 zu den Geräten, bei denen man mit Panzerglas nicht glücklich wird, außer es ist massiv zu klein geschnitten. Ansonsten tritt leider mehr oder weniger der Effekt auf, dass die Kanten des Panzerglas abheben und nicht anhaften, da das Display am Rand eine leichte Krümmung aufweist. Das dies aber so massiv ausfällt, hatte ich nicht erwartet - zumal die Produktfotos (offensichtlich überarbeitet) eine vollflächige Anhaftung und gleichmäßige Optik suggerieren. Mir ist es eindeutig zu viel, zumal sich unter dem abhebenden Rand bereits dreck sammelt und die die Touchbedienung am Rand des Displays bereits einschränkt. Ich habe das Glas wieder runter gemacht und bin derzeit bei dem Glas von Spigen, dass das Problem jedoch zumindest an den seitlichen Rändern ebenfalls - wenn auch nicht so massiv - aufweist. Alles in allem kann ich nur von dem Kauf abraten, wenn man mit der Problematik nicht leben kann, in diesem Fall führt wohl kein Weg an einer TPU oder PET Folie vorbei... Darüber hinaus ein Problem, dass ich bereits in der Vergangenheit bei einigen billigen China-</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Training">Training<a class="anchor-link" href="#Training"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Print out the model so we can build a custom set of parameter groups for an MBart + Sequence Classification task</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">def</span> <span class="nf">mbart_splitter</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
  <span class="n">model</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">hf_model</span> <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s1">&#39;hf_model&#39;</span><span class="p">))</span> <span class="k">else</span> <span class="n">m</span>
  
  <span class="n">embeds_modules</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">embed_positions</span><span class="p">,</span> 
    <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">embed_tokens</span><span class="p">,</span>
    <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">embed_positions</span><span class="p">,</span> 
    <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">embed_tokens</span>
  <span class="p">]</span>
 
  <span class="n">embeds</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">embeds_modules</span><span class="p">)</span>
  <span class="n">groups</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">embeds</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">encoder</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">decoder</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">classification_head</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">groups</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">el</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Configure our metrics and callbacks required by <code>blurr</code></p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">precision</span> <span class="o">=</span> <span class="n">Precision</span><span class="p">(</span><span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>
<span class="n">recall</span> <span class="o">=</span> <span class="n">Recall</span><span class="p">(</span><span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>
<span class="n">f1</span> <span class="o">=</span> <span class="n">F1Score</span><span class="p">(</span><span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>

<span class="n">learn_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">f1</span><span class="p">]</span>
<span class="n">learn_cbs</span> <span class="o">=</span> <span class="p">[</span><span class="n">HF_BaseModelCallback</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Configure our <code>Learner</code> and train away ...</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">HF_BaseModelWrapper</span><span class="p">(</span><span class="n">hf_model</span><span class="p">)</span>
<span class="n">learn</span> <span class="o">=</span> <span class="n">Learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">opt_func</span><span class="o">=</span><span class="n">Adam</span><span class="p">,</span> <span class="n">loss_func</span><span class="o">=</span><span class="n">CrossEntropyLossFlat</span><span class="p">(),</span> <span class="n">metrics</span><span class="o">=</span><span class="n">learn_metrics</span><span class="p">,</span> <span class="n">cbs</span><span class="o">=</span><span class="n">learn_cbs</span><span class="p">,</span> <span class="n">splitter</span><span class="o">=</span><span class="n">mbart_splitter</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">param_groups</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>4
</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">lr_find</span><span class="p">(</span><span class="n">suggestions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>SuggestedLRs(lr_min=7.585775892948732e-06, lr_steep=0.013182567432522774)</pre>
</div>

</div>

<div class="output_area">



<div class="output_png output_subarea ">
<img src="data:image/png;base64,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
" />
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lr_max</span><span class="o">=</span><span class="mf">7e-5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

    <div>
        <style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
      <progress value="0" class="" max="1" style="width:300px; height:20px; vertical-align: middle;"></progress>
      0.00% [0/1 00:00&lt;00:00]
    </div>
    
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>precision_score</th>
      <th>recall_score</th>
      <th>f1_score</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table><p>

    <div>
        <style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
      <progress value="46182" class="" max="50000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      92.36% [46182/50000 1:41:30&lt;08:23 0.9709]
    </div>
    
&lt;/div&gt;

&lt;/div&gt;

&lt;/div&gt;
&lt;/div&gt;

&lt;/div&gt;
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">show_results</span><span class="p">(</span><span class="n">learner</span><span class="o">=</span><span class="n">learn</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">trunc_at</span><span class="o">=</span><span class="mi">1500</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We'll freeze all the layers with the exception of the decoder and classification_head layers (the last 2)</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">freeze_to</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">lr_find</span><span class="p">(</span><span class="n">suggestions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">lr_max</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mf">2e-8</span><span class="p">,</span> <span class="mf">2e-7</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">recorder</span><span class="o">.</span><span class="n">plot_loss</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">show_results</span><span class="p">(</span><span class="n">learner</span><span class="o">=</span><span class="n">learn</span><span class="p">,</span> <span class="n">max_n</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">trunc_at</span><span class="o">=</span><span class="mi">1500</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Inference">Inference<a class="anchor-link" href="#Inference"> </a></h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">txt</span> <span class="o">=</span> <span class="n">tst_df</span><span class="o">.</span><span class="n">review_body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">blurr_predict</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">txts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tst_df</span><span class="o">.</span><span class="n">review_body</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">txts</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">blurr_predict</span><span class="p">(</span><span class="n">txts</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Well that's it!</p>
<p>I hope this article helps your fastai, huggingface, blurr out, and hey, if I'm doing something wrong above please let me know!  I'm far from perfect :)</p>
<p>For more information on the MBart/MBar-50 architecture, see the huggingface docs <a href="https://huggingface.co/transformers/model_doc/mbart.html">here</a>.</p>

</div>
</div>
</div>
&lt;/div&gt;
 

</p></div></div></div></div></div></div>


  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="ohmeow/ohmeow_website"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/temp-posts/mbart" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p>A full-stack web application and ML development company.</p>
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a class="fa-icon" rel="me" href="mailto:wgilliam@ohmeow.com" title="wgilliam@ohmeow.com"><i class="far fa-envelope"></i></a></li><li><a rel="me" href="https://github.com/ohmeow" title="ohmeow"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/waydegilliam" title="waydegilliam"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul></div>

  </div>

</footer></body>

</html>
